// SPDX-License-Identifier: GPL-3.0
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNXK0OOOOO0KXNWWWWWWWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWXOdl;'...........,:oOXWWWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWXkc'. .';:clooooolc:,. .,oKWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNKK0000KXXXNNNNNWWKo' .'cdk00KKKKKKKKKK00Od;. .dNWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNOo;'.........'',,,:kx' .;dO0K0Oxlc:;;:cdk0K00K0x, .dNWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWO:.    .....        .,. 'd000KOo,. .'',.. .lOKK00Kd. ,KWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW0,     :OXXX0:       .. 'xKK000l. ,xKXNNXx' .dKKK0Kx' '0WWWWWWWWW
//      WWWWWWWWWWWWWWX0kxdooooodk0NWWWXOOx;     .oOOXWWo       .  c000000:  lXNWNX0l. ,kK00K0l. cXWWWWWWWWW
//      WWWWWWWWWWWNOc'.          .,xXO,.            :KX:      ';. :000KK0x,  .,;,'. .:x000KOl. ,OWWWWWWWWWW
//      WWWWWWWWWWNo.     .::'      .kx'..       ...'dNk.      lO; .:x00000Odc;,,,;cok000Oxc' .:0WWWWWWWWWWW
//      WWWWWWWWWWK;     .dNWK;     .xWXKd.     ;OKKXWNl      .kW0;  .'cx00KKKK0000KK0kl;.  .:kNWWWWWWWWWWWW
//      WWWWWWWWWWWOl;,;ckKKkc.     ,KWWWd.    .xWWWWW0,      :Od;. .';lx000OOkkOO0000Od:,. .c0WWWWWWWWWWWWW
//      WWWWWWWWWWNKkoc:;,..        lNWWX:     ;KWWWWWx.      .. .,lxO00xl;'......,:dO0K00xc. .xNWWWWWWWWWWW
//      WWWWWWWWNk;.        .      .kWWWk.     oNWWWWX:        .:x000Oo,. .;clool:'  ,x0K000d. 'OWWWWWWWWWWW
//      WWWWWWWXl.     'cdkOo.     :XWWNl     'OWWWWWO.       .o0KKKOc. ,xKNWWWWWWXo. ,kK00K0c .oWWWWWWWWWWW
//      WWWWWWWx.     ,ONNKx'      lKXKk'     ,OXWWX0:        ;xO0KKd. ;KWWWWWWWWWWx. ,kKK00O: .dWWWWWWWWWWW
//      WWWWWWWd.      .,'.        .....       .cKd'.          .l0KKd. 'kNWWWWWWXOl. .d00KK0d. ,0WWWWWWWWWWW
//      WWWWWWW0;          .,.                 .o0;            'x00K0o. .';ccc:;.. .:x0KKK0d' .xWWWWWWWWWWWW
//      WWWWWWWWXxc;,'',:lx0N0l;,,:clooddxxddooONNOdodxxxdo;  .d000KK0Oo:,'...',;cok0KKK0x:. 'kNWWWWWWWWWWWW
//      WWWWWWWWWWWWNNNNWWWWWWWWNNWWWWWWWWWWWWWWWWWWWWWWWWWKc  ,oO0KKK0K000OO0000K0KK0ko;. .lKWWWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWXx,. .:ldkO00000000OOxdl:'. .;dKWWWWWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWXOl,......',,,,,'......,cd0NWWWWWWWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWNKOxoc::;;;;;:cloxOKNWWWWWWWWWWWWWWWWWWWWWW
//      WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW
//
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Aron Mauritala Ayuk                                                                                                                                          //
//      @msg            ::              stereo@iii6.xyz                                                                                                                                   //
//      @github         ::              @stereoIII6
//      @twitter        ::              @stereoIII6                                                                                                                                              //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @dev            ::              Juan Xavier Valverde                                                                                                                                    //
//      @msg            ::              juanxavier@iii6.xyz                                                                                                                               //
//      @twitter        ::              @JuanXavier                                                                                                                                             //
//      @github         ::              @JuanXavier                                                                                                                                             //
//                                                                                                                                                                                  //                                                                                                                                                                                 //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//                                                                                                                                                                                  //
//      @company        ::              Fractio Holding                                                                                                                                                                       //
//      @title          ::              iii6 Coin Model                                                                                                                            //
//      @description    ::              ERC20 Model Preset Contract                                                                                                                           //
//      @version        ::              0.0.1                                                                                                                                       //
//      @purpose        ::              ERC20 Model Preset                                                                                                          //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
//                                                                                                                                                                                  //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //
//  *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   *   //
// // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // // //

pragma solidity ^0.8.7;

import "../iii6utils/Assets/iii6CoinModel.sol";
import "../iii6utils/Assets/iii6DiaModel.sol";
import "../iii6utils/Misc/iii6Misc.sol";

contract AFL8_CampaignModel is iii6DiaModel, iii6Misc {
    iii6CoinModel public afl8;
    uint256 FEE;
    struct Campaign {
        uint256 id;
        address author;
        uint256 start;
        uint256 budget;
        uint256 price;
        uint256 actions;
        bytes dias;
        CampaignType ctype;
        Status state;
    }
    uint256 public C_ID;
    Campaign[] public campaigns;
    mapping(address => uint256) campaignCount;
    mapping(address => mapping(uint256 => Campaign)) public campaignShow;
    mapping(uint256 => uint256) public campaignSafe;

    // initialises the contract at deployment
    constructor()
        iii6DiaModel(msg.sender, "Affiliate Campaign Asset", "AFL8", 0, 0, 0)
    {
        // afl8 = iii6CoinModel();
    }

    // function takes (campaign type , budget , price) and returns (actions)=>{Views,Clicks,Leads,Sales}
    function _calcActions(
        CampaignType _ctype,
        uint256 _budget,
        uint256 _price
    ) internal pure returns (uint256 actions) {
        if (_ctype == CampaignType.View) {
            // VIEW CAMPAIGNS
            require(_price >= 5 * 10**15, ":: price too low ::");
            actions = _budget / _price;
        } else if (_ctype == CampaignType.Click) {
            // CLICK CAMPAIGNS
            require(_price >= 5 * 10**16, ":: price too low ::");
            actions = _budget / _price;
        } else if (_ctype == CampaignType.Lead) {
            // LEAD CAMPAIGNS
            require(_price >= 5 * 10**17, ":: price too low ::");
            actions = _budget / _price;
        } else if (_ctype == CampaignType.Sale) {
            // SALE CAMPAIGNS
            require(_price >= 5 * 10**18, ":: price too low ::");
            actions = _budget / _price;
        } else {
            // ERROR FALLBACK
            actions = 0;
        }
    }

    // function makes a new Campaign from input() and mints a campaign token
    function _makeCampaign(
        uint256 _start,
        uint256 _budget,
        uint256 _price,
        uint256 _actions,
        string memory _dias,
        CampaignType _ctype,
        Status _state
    ) internal returns (bool) {
        // Write Struct to Array & Mapping
        campaigns.push(
            Campaign(
                C_ID,
                msg.sender,
                _start,
                _budget,
                _price,
                _actions,
                bytes(_dias),
                _ctype,
                _state
            )
        );
        campaignShow[msg.sender][campaignCount[msg.sender]] = campaigns[C_ID];
        // Iterate
        campaignCount[msg.sender]++;
        _mint(msg.sender, C_ID);
        C_ID++;
        // Exit
        return true;
    }

    // function pauses campaign
    function _pauseCampaign(uint256 _cid) internal returns (bool) {
        // get campaign data
        Campaign memory campaign = campaigns[_cid];
        // set campaign status
        campaign.state = Status.Paused;
        // write new state to campaign
        campaigns[_cid] = campaign;
        // exit with bool
        return false;
    }

    // function starts campaign
    function _startCampaign(uint256 _cid) internal returns (bool) {
        // get campaign data
        Campaign memory campaign = campaigns[_cid];
        // set campaign status
        campaign.state = Status.Active;
        // write new state to campaign
        campaigns[_cid] = campaign;
        // exit with bool
        return true;
    }

    // function starts campaign
    function _endCampaign(uint256 _cid) internal returns (bool) {
        // get campaign data
        Campaign memory campaign = campaigns[_cid];
        // set campaign status
        campaign.state = Status.Ended;
        // write new state to campaign
        campaigns[_cid] = campaign;
        // exit with bool
        return true;
    }

    // function handles payment and calls make campaign
    function createCampaign(
        uint256 _start,
        uint256 _budget,
        uint256 _price,
        string memory _dias,
        uint256 _ctype
    ) external returns (bool) {
        // check fund availability
        uint256 checksum = (5 * 10**18) + _budget;
        require(
            afl8.balanceOf(msg.sender) >= checksum,
            ":: insufficient funds ::"
        );
        // Translate Campaign Type to ENUM
        CampaignType ctyp;
        if (_ctype == 0) {
            ctyp = CampaignType.View;
        } else if (_ctype == 1) {
            ctyp = CampaignType.Click;
        } else if (_ctype == 2) {
            ctyp = CampaignType.Lead;
        } else if (_ctype == 3) {
            ctyp = CampaignType.Sale;
        } else {
            ctyp = CampaignType.Inactive;
        }
        // Calculate Action Count from Input
        uint256 actions = _calcActions(ctyp, _budget, _price);
        require(actions != 0, ":: not enough budget ::");
        // Check Timing & Set Status ENUM
        Status stat = Status.Pending;
        if (_start < block.timestamp) {
            stat = Status.Active;
        }
        // Transfer funds from user to contract
        afl8.transferFrom(msg.sender, address(this), checksum);
        // create Campaign Token
        return
            _makeCampaign(_start, _budget, _price, actions, _dias, ctyp, stat);
    }

    // function changes campaign state
    function changeState(uint256 _cid, bool _quit) external returns (bool) {
        // get campaign data
        Campaign memory campaign = campaigns[_cid];
        // check if campaign is started or ended
        if (_quit) {
            return _endCampaign(_cid);
        }
        if (
            campaign.start < block.timestamp && campaign.state != Status.Ended
        ) {
            // check campaign state
            if (
                campaign.state == Status.Pending ||
                campaign.state == Status.Paused
            ) {
                // exit set to active
                return _startCampaign(_cid);
            } else {
                // exit set to paused
                return _pauseCampaign(_cid);
            }
        }
        // exit with bool
        else return false;
    }
}
